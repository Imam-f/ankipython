<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TTS Word Reader (Full Info)</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
        background: #fafafa;
      }
      button {
        padding: 0.6em 1em;
        margin: 0.3em;
        font-size: 1em;
      }
      label {
        display: inline-block;
        margin-top: 1em;
      }
      input[type="range"] {
        width: 200px;
        vertical-align: middle;
      }
      pre {
        background: #eee;
        padding: 1em;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      audio {
        display: block;
        margin-top: 1em;
        width: 100%;
      }
      .controls {
        margin-bottom: 1em;
      }
      .field {
        margin-bottom: 0.5em;
      }
      .field span {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Word Reader (Full Info)</h1>

    <div class="controls">
      <button id="nextBtn">Next Word</button>
      <button id="replayBtn">Re‑Play</button>
      <label style="margin-left: 1em;">
        <input type="checkbox" id="autoplayChk" />
        Autoplay
      </label>
    </div>

    <label>
      Speed:
      <input
        type="range"
        id="speedSlider"
        min="0.5"
        max="1.5"
        step="0.1"
        value="1"
      />
      <span id="speedLabel">1.0×</span>
    </label>

    <div id="info">
      <pre>Press "Next Word" to start.</pre>
    </div>

    <audio id="player" controls></audio>

    <script>
      const nextBtn = document.getElementById("nextBtn");
      const replayBtn = document.getElementById("replayBtn");
      const autoplayChk = document.getElementById("autoplayChk");
      const speedSlider = document.getElementById("speedSlider");
      const speedLabel = document.getElementById("speedLabel");
      const infoDiv = document.getElementById("info");
      const player = document.getElementById("player");

      let lastWord = null;
      let currentSpeed = parseFloat(speedSlider.value);

      speedSlider.addEventListener("input", () => {
        currentSpeed = parseFloat(speedSlider.value);
        speedLabel.textContent = `${currentSpeed.toFixed(1)}×`;
        player.playbackRate = currentSpeed;
      });

      player.addEventListener("loadedmetadata", () => {
        player.playbackRate = currentSpeed;
      });

      player.addEventListener("ended", () => {
        if (autoplayChk.checked) {
          fetchAndPlayNext();
        }
      });

      async function fetchAndPlayNext() {
        infoDiv.innerHTML = "<pre>Loading next word...</pre>";
        const res = await fetch("/next");
        const data = await res.json();
        if (data.error) {
          infoDiv.innerHTML = `<pre>${data.error}</pre>`;
          return;
        }

        lastWord = data.word;

        const html = `
          <div class="field"><span>Word:</span> ${data.word}</div>
          <div class="field"><span>Definition:</span> ${data.definition}</div>
          <div class="field"><span>Recent Usage:</span> ${
            data.recent_usage || "(none)"
          }</div>
          <div class="field"><span>Etymology:</span> ${
            data.etymology || "(none)"
          }</div>
          <div class="field"><span>Synonyms:</span> ${
            data.synonyms || "(none)"
          }</div>
          <div class="field"><span>Antonyms:</span> ${
            data.antonyms || "(none)"
          }</div>
          <div class="field"><span>Frequency:</span> ${
            data.frequency
          }</div>
          <div class="field"><span>Times Read (after this):</span> ${
            data.count + 1
          }</div>
        `;
        infoDiv.innerHTML = html;

        player.src = `/audio/${encodeURIComponent(data.word)}`;
        player.playbackRate = currentSpeed;
        await player.play().catch(() => {});
      }

      nextBtn.addEventListener("click", fetchAndPlayNext);

      replayBtn.addEventListener("click", () => {
        if (lastWord) {
          player.currentTime = 0;
          player.play();
        } else {
          infoDiv.innerHTML = "<pre>No word loaded yet.</pre>";
        }
      });
    </script>
  </body>
</html>