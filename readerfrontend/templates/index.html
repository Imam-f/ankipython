<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TTS Word Reader (Autoplay + Speed Fix)</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
        background: #fafafa;
      }
      button {
        padding: 0.6em 1em;
        margin: 0.3em;
        font-size: 1em;
      }
      label {
        font-weight: bold;
        display: inline-block;
        margin-top: 1em;
      }
      input[type="range"] {
        width: 200px;
        vertical-align: middle;
      }
      pre {
        background: #eee;
        padding: 1em;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      audio {
        display: block;
        margin-top: 1em;
        width: 100%;
      }
      .controls {
        margin-bottom: 1em;
      }
    </style>
  </head>
  <body>
    <h1>Word Reader</h1>

    <div class="controls">
      <button id="nextBtn">Next Word</button>
      <button id="replayBtn">Re‑Play</button>
      <label style="margin-left: 1em;">
        <input type="checkbox" id="autoplayChk" />
        Autoplay
      </label>
    </div>

    <label>
      Speed:
      <input
        type="range"
        id="speedSlider"
        min="0.5"
        max="1.5"
        step="0.1"
        value="1"
      />
      <span id="speedLabel">1.0×</span>
    </label>

    <pre id="output">Press “Next Word” to start.</pre>
    <audio id="player" controls></audio>

    <script>
      const nextBtn = document.getElementById("nextBtn");
      const replayBtn = document.getElementById("replayBtn");
      const autoplayChk = document.getElementById("autoplayChk");
      const output = document.getElementById("output");
      const player = document.getElementById("player");
      const speedSlider = document.getElementById("speedSlider");
      const speedLabel = document.getElementById("speedLabel");

      let lastWord = null;
      let currentSpeed = parseFloat(speedSlider.value);

      // --- HANDLE SPEED SLIDER ---

      speedSlider.addEventListener("input", () => {
        currentSpeed = parseFloat(speedSlider.value);
        speedLabel.textContent = `${currentSpeed.toFixed(1)}×`;
        player.playbackRate = currentSpeed; // apply immediately
      });

      // When new audio loads, ensure it keeps the current speed
      player.addEventListener("loadedmetadata", () => {
        player.playbackRate = currentSpeed;
      });

      // --- HANDLE AUTOPLAY ---
      player.addEventListener("ended", () => {
        if (autoplayChk.checked) {
          fetchAndPlayNext();
        }
      });

      // --- MAIN FUNCTION ---
      async function fetchAndPlayNext() {
        output.textContent = "Fetching next word...";
        try {
          const res = await fetch("/next");
          const data = await res.json();

          if (data.error) {
            output.textContent = data.error;
            return;
          }

          lastWord = data.word;
          output.textContent = `Word: ${data.word}
Definition: ${data.definition}
Frequency: ${data.frequency}
Times Read (after this): ${data.count + 1}`;

          player.src = `/audio/${encodeURIComponent(data.word)}`;

          // Force reapply speed after src change
          player.playbackRate = currentSpeed;

          // Start playing automatically if autoplay is on
          await player.play().catch(() => {});
        } catch (err) {
          output.textContent = `Error fetching next word: ${err}`;
        }
      }

      // --- BUTTONS ---
      nextBtn.addEventListener("click", fetchAndPlayNext);

      replayBtn.addEventListener("click", () => {
        if (lastWord) {
          player.currentTime = 0;
          player.play();
        } else {
          output.textContent = "No word loaded yet.";
        }
      });
    </script>
  </body>
</html>